#!/usr/bin/env bash

# Collates SimpleCov results from parallel spec runs and checks minimum coverage
#
# This script should be run after bin/rspecs_parallel or bin/rspecs to verify
# code coverage meets the minimum threshold.
#
# Coverage thresholds are defined in spec/support/coverage_config.rb

set -e

echo "Collating SimpleCov coverage results..."

bundle exec ruby -e "
  require 'simplecov'
  require_relative 'spec/support/coverage_config'

  SimpleCov.collate Dir['coverage/.resultset.json'], 'rails' do
    add_filter '/spec/'
    add_filter '/vendor/'
    add_filter '/gems/'
    add_filter '/.bundle/'
    add_filter '/doc/'
    add_filter '/config/'
    enable_coverage :branch
    minimum_coverage(
      line: CoverageConfig::LINE_COVERAGE,
      branch: CoverageConfig::BRANCH_COVERAGE
    )
  end
"
