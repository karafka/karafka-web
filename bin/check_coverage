#!/usr/bin/env bash

# Collates SimpleCov results from parallel spec runs and checks minimum coverage
#
# This script should be run after bin/rspecs_parallel or bin/rspecs to verify
# code coverage meets the minimum threshold.
#
# Environment variables:
#   MINIMUM_COVERAGE - minimum coverage percentage (default: 92)

set -e

MINIMUM_COVERAGE="${MINIMUM_COVERAGE:-92}"

echo "Collating SimpleCov coverage results..."
echo "  Minimum coverage: ${MINIMUM_COVERAGE}%"

bundle exec ruby -e "
  require 'simplecov'

  SimpleCov.collate Dir['coverage/.resultset.json'], 'rails' do
    add_filter '/spec/'
    add_filter '/vendor/'
    add_filter '/gems/'
    add_filter '/.bundle/'
    add_filter '/doc/'
    add_filter '/config/'
    enable_coverage :branch
    minimum_coverage ${MINIMUM_COVERAGE}
  end
"
