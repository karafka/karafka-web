#!/usr/bin/env bash

set -e

# Run specs in parallel or sequentially based on PARALLEL env var
if [ "${PARALLEL:-false}" = "true" ]; then
  echo "Running specs in parallel mode with 8 independent processes..."

  # Create temp directory for logs
  TMPDIR=$(mktemp -d)
  trap "rm -rf $TMPDIR" EXIT

  # Launch all 8 spec groups simultaneously
  # Regular specs (4 processes)
  PARALLEL=true PARALLEL_GROUP=ui SPECS_TYPE=regular bundle exec rspec spec/lib/karafka/web/ui --format progress > "$TMPDIR/ui.log" 2>&1 &
  PID1=$!
  PARALLEL=true PARALLEL_GROUP=tracking SPECS_TYPE=regular bundle exec rspec spec/lib/karafka/web/tracking --format progress > "$TMPDIR/tracking.log" 2>&1 &
  PID2=$!
  PARALLEL=true PARALLEL_GROUP=processing SPECS_TYPE=regular bundle exec rspec spec/lib/karafka/web/processing --format progress > "$TMPDIR/processing.log" 2>&1 &
  PID3=$!
  PARALLEL=true PARALLEL_GROUP=other SPECS_TYPE=regular bundle exec rspec spec/lib/karafka/web/management spec/lib/karafka/web/cli spec/lib/karafka/web/deserializer_spec.rb spec/lib/karafka/web/cli_spec.rb spec/lib/karafka/web/installer_spec.rb spec/lib/karafka/web/inflector_spec.rb spec/lib/karafka/web/errors_spec.rb --format progress > "$TMPDIR/other.log" 2>&1 &
  PID4=$!

  # Pro specs (4 processes)
  PARALLEL=true PARALLEL_GROUP=pro_controllers SPECS_TYPE=pro bundle exec rspec spec/lib/karafka/web/pro/ui/controllers --format progress > "$TMPDIR/pro_controllers.log" 2>&1 &
  PID5=$!
  PARALLEL=true PARALLEL_GROUP=pro_lib SPECS_TYPE=pro bundle exec rspec spec/lib/karafka/web/pro/ui/lib --format progress > "$TMPDIR/pro_lib.log" 2>&1 &
  PID6=$!
  PARALLEL=true PARALLEL_GROUP=pro_commanding SPECS_TYPE=pro bundle exec rspec spec/lib/karafka/web/pro/commanding --format progress > "$TMPDIR/pro_commanding.log" 2>&1 &
  PID7=$!
  PARALLEL=true PARALLEL_GROUP=pro_other SPECS_TYPE=pro bundle exec rspec spec/lib/karafka/web/pro/commanding_spec.rb spec/lib/karafka/web/pro/loader_spec.rb --format progress > "$TMPDIR/pro_other.log" 2>&1 &
  PID8=$!

  echo "Started 8 parallel spec processes: $PID1 $PID2 $PID3 $PID4 $PID5 $PID6 $PID7 $PID8"

  # Wait for all processes and collect exit codes
  FAILED=0
  for PID in $PID1 $PID2 $PID3 $PID4 $PID5 $PID6 $PID7 $PID8; do
    if ! wait $PID; then
      FAILED=1
    fi
  done

  # Show all logs
  echo "=== Regular UI Specs ===" && cat "$TMPDIR/ui.log"
  echo "=== Regular Tracking Specs ===" && cat "$TMPDIR/tracking.log"
  echo "=== Regular Processing Specs ===" && cat "$TMPDIR/processing.log"
  echo "=== Regular Other Specs ===" && cat "$TMPDIR/other.log"
  echo "=== Pro Controllers Specs ===" && cat "$TMPDIR/pro_controllers.log"
  echo "=== Pro Lib Specs ===" && cat "$TMPDIR/pro_lib.log"
  echo "=== Pro Commanding Specs ===" && cat "$TMPDIR/pro_commanding.log"
  echo "=== Pro Other Specs ===" && cat "$TMPDIR/pro_other.log"

  if [ $FAILED -eq 1 ]; then
    echo "Some specs failed!"
    exit 1
  fi

  echo "All specs passed!"

  # Collate SimpleCov results and check minimum coverage
  echo "Collating SimpleCov coverage results..."
  bundle exec ruby -e "
    require 'simplecov'

    SimpleCov.collate Dir['coverage/.resultset.json'], 'rails' do
      add_filter '/spec/'
      add_filter '/vendor/'
      add_filter '/gems/'
      add_filter '/.bundle/'
      add_filter '/doc/'
      add_filter '/config/'
      enable_coverage :branch
      minimum_coverage 92
    end
  "
else
  echo "Running specs in sequential mode..."

  SPECS_TYPE=regular bundle exec rspec \
    spec/lib \
    --exclude-pattern "**/pro/**/*_spec.rb"

  SPECS_TYPE=pro bundle exec rspec \
    spec/lib/karafka/web/pro
fi
