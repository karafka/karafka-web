#!/usr/bin/env bash

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Number of workers per spec type
REGULAR_WORKERS="${REGULAR_WORKERS:-4}"
PRO_WORKERS="${PRO_WORKERS:-4}"

# Run specs in parallel or sequentially based on PARALLEL env var
if [ "${PARALLEL:-false}" = "true" ]; then
  echo "Running specs in parallel mode..."
  echo "  Regular workers: $REGULAR_WORKERS"
  echo "  Pro workers: $PRO_WORKERS"

  # Create temp directory for logs
  TMPDIR=$(mktemp -d)
  trap "rm -rf $TMPDIR" EXIT

  # Get balanced file lists from the balancer
  echo ""
  echo "=== Balancing Regular Specs ==="
  readarray -t REGULAR_GROUPS < <("$SCRIPT_DIR/balance_specs" regular "$REGULAR_WORKERS" bash)

  echo ""
  echo "=== Balancing Pro Specs ==="
  readarray -t PRO_GROUPS < <("$SCRIPT_DIR/balance_specs" pro "$PRO_WORKERS" bash)

  echo ""
  echo "Starting parallel execution..."

  # Launch regular spec workers
  PIDS=()
  for i in $(seq 0 $((REGULAR_WORKERS - 1))); do
    if [ -n "${REGULAR_GROUPS[$i]}" ]; then
      PARALLEL=true PARALLEL_GROUP="regular_$i" SPECS_TYPE=regular \
        bundle exec rspec ${REGULAR_GROUPS[$i]} --format progress \
        > "$TMPDIR/regular_$i.log" 2>&1 &
      PIDS+=($!)
      echo "  Started regular worker $((i + 1)) (PID ${PIDS[-1]}): $(echo ${REGULAR_GROUPS[$i]} | wc -w) files"
    fi
  done

  # Launch pro spec workers
  for i in $(seq 0 $((PRO_WORKERS - 1))); do
    if [ -n "${PRO_GROUPS[$i]}" ]; then
      PARALLEL=true PARALLEL_GROUP="pro_$i" SPECS_TYPE=pro \
        bundle exec rspec ${PRO_GROUPS[$i]} --format progress \
        > "$TMPDIR/pro_$i.log" 2>&1 &
      PIDS+=($!)
      echo "  Started pro worker $((i + 1)) (PID ${PIDS[-1]}): $(echo ${PRO_GROUPS[$i]} | wc -w) files"
    fi
  done

  echo ""
  echo "Waiting for ${#PIDS[@]} workers to complete..."

  # Wait for all processes and collect exit codes
  FAILED=0
  FAILED_WORKERS=()
  for idx in "${!PIDS[@]}"; do
    PID="${PIDS[$idx]}"
    if ! wait "$PID"; then
      FAILED=1
      FAILED_WORKERS+=("$idx")
    fi
  done

  # Show all logs
  echo ""
  echo "=========================================="
  echo "                 RESULTS                  "
  echo "=========================================="

  for i in $(seq 0 $((REGULAR_WORKERS - 1))); do
    if [ -f "$TMPDIR/regular_$i.log" ]; then
      echo ""
      echo "=== Regular Worker $((i + 1)) ==="
      cat "$TMPDIR/regular_$i.log"
    fi
  done

  for i in $(seq 0 $((PRO_WORKERS - 1))); do
    if [ -f "$TMPDIR/pro_$i.log" ]; then
      echo ""
      echo "=== Pro Worker $((i + 1)) ==="
      cat "$TMPDIR/pro_$i.log"
    fi
  done

  if [ $FAILED -eq 1 ]; then
    echo ""
    echo "=========================================="
    echo "         SOME SPECS FAILED!              "
    echo "=========================================="
    exit 1
  fi

  echo ""
  echo "=========================================="
  echo "          ALL SPECS PASSED!               "
  echo "=========================================="

  # Collate SimpleCov results and check minimum coverage
  echo ""
  echo "Collating SimpleCov coverage results..."
  bundle exec ruby -e "
    require 'simplecov'

    SimpleCov.collate Dir['coverage/.resultset.json'], 'rails' do
      add_filter '/spec/'
      add_filter '/vendor/'
      add_filter '/gems/'
      add_filter '/.bundle/'
      add_filter '/doc/'
      add_filter '/config/'
      enable_coverage :branch
      minimum_coverage 92
    end
  "
else
  echo "Running specs in sequential mode..."

  SPECS_TYPE=regular bundle exec rspec \
    spec/lib \
    --exclude-pattern "**/pro/**/*_spec.rb"

  SPECS_TYPE=pro bundle exec rspec \
    spec/lib/karafka/web/pro
fi
